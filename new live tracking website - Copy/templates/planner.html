{% extends "base.html" %}
{% block content %}
<style>
    /* Planner Specific Styles for Chat and Layout */
    .planner-main-grid {
        /* New Layout: Chat (1.2fr) | Planning (1fr) */
        display: grid;
        grid-template-columns: 1.2fr 1fr; 
        gap: 30px;
    }

    .planning-and-diet-container {
        /* Container for the Plan Creator and Diet Box */
        display: flex;
        flex-direction: column;
        gap: 30px;
        flex: 1; 
    }
    
    .planning-and-diet-row {
        /* This container holds the Plan Creator and Diet Card side-by-side */
        display: grid;
        grid-template-rows: auto auto; 
        gap: 30px; 
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 600px; /* Fixed height for visual consistency */
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        overflow: hidden;
    }
    #chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        scroll-behavior: smooth;
    }
    .chat-input-area {
        display: flex;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
    }
    .chat-message {
        margin-bottom: 15px;
        display: flex;
    }
    .bot-message {
        justify-content: flex-start;
    }
    .user-message {
        justify-content: flex-end;
    }
    .message-bubble {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.4;
    }
    .bot-bubble {
        background: var(--primary);
        color: white;
        border-bottom-left-radius: 2px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background: white;
        color: #333;
        border-bottom-right-radius: 2px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .message-date {
        font-size: 0.75rem;
        opacity: 0.6;
        margin-top: 4px;
    }
</style>

<div class="fade-in">
    <h1 style="text-align: center; margin-bottom: 30px;"><i class="fas fa-calendar-check"></i> Your AI Fitness Hub</h1>

    <div class="planner-main-grid">
        
        <div>
             <div class="card" style="padding: 0; background: rgba(0, 0, 0, 0.2);">
                <div style="padding: 15px 20px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="margin: 0;"><i class="fas fa-comments"></i> AI Workout Coach Chat</h3>
                </div>
                
                <div class="chat-container">
                    <div id="chat-messages">
                        </div>

                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Ask about your reps, calories, or history..." style="flex-grow: 1; margin-right: 10px; padding-left: 15px;">
                        <button class="btn btn-primary" onclick="handleUserQuery()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <div>
            
            <div class="planning-and-diet-row">
                
                <div class="card">
                    <h3><i class="fas fa-plus-circle"></i> Create Daily Plan</h3>
                    
                    <label style="font-size: 0.9rem; margin-left: 5px;">Select Date</label>
                    <div class="input-group">
                        <i class="fas fa-calendar-day"></i>
                        <input type="date" id="pDate">
                    </div>

                    <label style="font-size: 0.9rem; margin-left: 5px;">Workout Focus</label>
                    <div class="input-group">
                        <i class="fas fa-running"></i>
                        <select id="pFocus">
                            <option value="" disabled selected>Choose Focus...</option>
                            <option value="Full Body">Full Body</option>
                            <option value="Upper Body">Upper Body</option>
                            <option value="Lower Body">Lower Body</option>
                            <option value="Cardio">Cardio / HIIT</option>
                            <option value="Rest">Active Recovery</option>
                        </select>
                    </div>

                    <div id="aiSuggestion" style="display:none; background: rgba(0,205,172,0.15); border: 1px solid var(--accent); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <strong style="color: var(--accent);"><i class="fas fa-lightbulb"></i> AI Suggestion:</strong>
                        <p id="suggestionText" style="font-size: 0.9rem; margin: 5px 0 0 0;"></p>
                    </div>
                    
                    <button class="btn btn-primary" onclick="getSuggestion()" style="width: 100%; margin-bottom: 10px; font-size: 0.9rem;">
                        <i class="fas fa-magic"></i> Get Workout Ideas
                    </button>

                    <button class="btn btn-accent" onclick="savePlan()" style="width: 100%;">
                        <i class="fas fa-save"></i> Save to Schedule
                    </button>
                </div>

                <div class="card" style="background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); border-left: 5px solid var(--accent);">
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="background: rgba(0,205,172,0.2); padding: 15px; border-radius: 50%;">
                            <i class="fas fa-apple-alt" style="font-size: 24px; color: var(--accent);"></i>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 5px;">Nutrition Insight</h3>
                            <p id="dietText" style="margin: 0; font-size: 0.95rem; opacity: 0.9;">
                                Add at least 3 workout plans to unlock your personalized AI nutrition strategy.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Upcoming Schedule</h3>
            <div id="planGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                </div>

        </div>
    </div>
</div>

<script>
    // --- Data Dictionaries (Using var for compatibility) ---
    var exercisesDB = {
        "Full Body": "Burpees, Kettlebell Swings, Thrusters",
        "Upper Body": "Pushups, Dumbbell Press, Bent-over Rows",
        "Lower Body": "Squats, Lunges, Calf Raises",
        "Cardio": "30min Run, Jump Rope, Cycling",
        "Rest": "Yoga, 15min Stretching, Foam Rolling"
    };
    var dietDB = {
        "Full Body": "Focus on <strong>Complex Carbs</strong> (Quinoa, Oats) and <strong>Lean Protein</strong>.",
        "Upper Body": "Increase <strong>Protein</strong> intake (Chicken, Tofu) and Hydration.",
        "Lower Body": "Eat <strong>Magnesium-rich foods</strong> (Spinach, Bananas) for recovery.",
        "Cardio": "Load on <strong>Electrolytes</strong> and easy-to-digest Carbs (Fruit, Rice).",
        "Rest": "Focus on <strong>Micronutrients</strong>: Berries, Leafy Greens, and Fiber."
    };

    // --- Chat Logic ---
    var reportData = null; 

    function appendMessage(sender, text, isHtml) {
        var chatBox = document.getElementById('chat-messages');
        var msgDiv = document.createElement('div');
        var bubble = document.createElement('div');
        var timeSpan = document.createElement('span');

        msgDiv.className = 'chat-message ' + sender + '-message';
        bubble.className = 'message-bubble ' + sender + '-bubble';

        if (isHtml) {
            bubble.innerHTML = text;
        } else {
            bubble.innerText = text;
        }
        
        timeSpan.className = 'message-date';
        timeSpan.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        bubble.appendChild(timeSpan);
        msgDiv.appendChild(bubble);
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight; 
    }

    function loadReportData() {
        fetch('/get_full_report')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                reportData = data;
                
                if (reportData && !reportData.error) {
                    var userName = '{{ user.name }}' || 'User'; 
                    appendMessage('bot', "Hello " + userName + "! I'm your AI Coach. I have your data for " + reportData.total_sessions + " sessions. Ask me about your 'reps', 'calories', or 'frequent exercise'.");
                } else {
                    appendMessage('bot', "Hello! I'm your AI Coach. I don't have any workout data yet. Start tracking to get personalized insights!");
                }
            });
    }

    function handleUserQuery() {
        var inputElement = document.getElementById('chat-input');
        var query = inputElement.value.trim().toLowerCase();
        if (!query) return;

        appendMessage('user', inputElement.value);
        inputElement.value = '';

        if (!reportData || reportData.error) {
            appendMessage('bot', "I cannot process your request because I have no workout history data yet. Please complete a workout session first!");
            return;
        }

        var response = "I'm sorry, I can only answer questions related to your workout statistics (reps, calories, total sessions, and frequent exercises). Try asking, 'What are my total reps?'";
        var userName = '{{ user.name }}' || 'User';

        if (query.includes('hello') || query.includes('hi')) {
            response = 'Welcome back, ' + userName + '! I see you\'ve completed ' + reportData.total_sessions + ' sessions. How can I help you?';
        } else if (query.includes('total reps') || query.includes('reps done')) {
            response = 'Your total lifetime reps across all recorded sessions is **' + reportData.total_reps.toLocaleString() + '**. Keep up the great work!';
            appendMessage('bot', response, true);
            return;
        } else if (query.includes('calories') || query.includes('burn')) {
            response = 'You have burned an estimated total of **' + reportData.total_calories.toFixed(2).toLocaleString() + ' kcal**! That\'s impressive consistency.';
            appendMessage('bot', response, true);
            return;
        } else if (query.includes('frequent exercise') || query.includes('most done')) {
            response = 'Your most frequently performed exercise is the **' + reportData.most_frequent_exercise.toUpperCase() + '**. You\'re building a strong foundation in that area!';
            appendMessage('bot', response, true);
            return;
        } else if (query.includes('sessions') || query.includes('workouts done')) {
            response = 'You have completed **' + reportData.total_sessions + '** tracked sessions since starting.';
            appendMessage('bot', response, true);
            return;
        }

        appendMessage('bot', response);
    }
    
    // Bind Enter key to chat input
    document.getElementById('chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleUserQuery();
        }
    });

    // --- Planner CRUD and Render Logic ---
    function getSuggestion() {
        var focus = document.getElementById('pFocus').value;
        var box = document.getElementById('aiSuggestion');
        var text = document.getElementById('suggestionText');
        
        if(!focus) return alert("Please select a workout focus first.");
        
        box.style.display = 'block';
        text.innerHTML = "Thinking...";
        
        setTimeout(function() {
            text.innerHTML = exercisesDB[focus] || "Select a focus to see exercises.";
        }, 500);
    }

    function savePlan() {
        var date = document.getElementById('pDate').value;
        var focus = document.getElementById('pFocus').value;
        
        if(!date || !focus) return alert("Please fill in date and focus.");

        var plans = JSON.parse(localStorage.getItem('ai_plans') || "[]");
        plans.push({ date: date, focus: focus });
        
        plans.sort(function(a,b) { return new Date(a.date) - new Date(b.date); });
        
        localStorage.setItem('ai_plans', JSON.stringify(plans));
        render();
        
        document.getElementById('aiSuggestion').style.display = 'none';
    }

    function deletePlan(index) {
        var plans = JSON.parse(localStorage.getItem('ai_plans'));
        plans.splice(index, 1);
        localStorage.setItem('ai_plans', JSON.stringify(plans));
        render();
    }

    function render() {
        var plans = JSON.parse(localStorage.getItem('ai_plans') || "[]");
        var grid = document.getElementById('planGrid');
        grid.innerHTML = "";

        if(plans.length === 0) {
            grid.innerHTML = "<p style='opacity:0.5; grid-column: 1/-1; text-align:center;'>No plans yet. Start by adding one!</p>";
        }

        plans.forEach(function(p, i) {
            var icon = "fa-dumbbell";
            if(p.focus === "Cardio") icon = "fa-running";
            if(p.focus === "Rest") icon = "fa-bed";

            var card = `
                <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; position: relative; border: 1px solid rgba(255,255,255,0.1);">
                    <button onclick="deletePlan(${i})" style="position: absolute; top: 10px; right: 10px; background:none; border:none; color: rgba(255,255,255,0.5); cursor:pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 5px;">${p.date}</div>
                    <div style="font-weight: bold; color: var(--accent); font-size: 1.1rem; margin-bottom: 5px;">
                        <i class="fas ${icon}"></i> ${p.focus}
                    </div>
                    <div style="font-size: 0.8rem; font-style: italic;">${exercisesDB[p.focus]}</div>
                </div>
            `;
            grid.innerHTML += card;
        });

        // Diet Logic
        if(plans.length > 0) {
            var counts = {};
            plans.forEach(function(p) { counts[p.focus] = (counts[p.focus] || 0) + 1; });
            var topFocus = Object.keys(counts).reduce(function(a, b) { return counts[a] > counts[b] ? a : b; });
            
            document.getElementById('dietText').innerHTML = 
                'Based on your heavy <strong>' + topFocus + '</strong> schedule:<br> ' + dietDB[topFocus];
        }
    }

    // --- Initialization ---
    function initPlanner() {
        render();
        loadReportData(); 
    }
    
    initPlanner();
</script>
{% endblock %}